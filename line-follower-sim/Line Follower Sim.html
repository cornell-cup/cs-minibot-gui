
<!-- saved from url=(0035)http://scwu.io/p/line-follower-sim/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
    <title>Line Follower Sim</title>
<script type="text/javascript">
var radius = 20;
var left_motor = 0;
var right_motor = 0;
/*
var sensors = [
    [radius, radius],
    [-radius, radius],
    [0, radius * 1.6]
];
*/
var sensors = [
    [radius, -radius *0.5],
    [radius, radius * 0.5],
    [radius+10, -radius*0.3],
    [radius+10, radius*0.3],
    [radius+20, 0]
];
var px = 400;
var py = 400;
var rot = Math.PI;

var code = new Function();
var state = {};

var canvas;
var ctx;
var floor;

var paused = false;

readTextFile = function()
{
    // document.getElementById("code").value = "Hello";
    var rawFile = new XMLHttpRequest();
    rawFile.open("GET", '/script.txt');
    rawFile.onreadystatechange = function ()
    {
        if(rawFile.readyState === 4)
        {
            if(rawFile.status === 200 || rawFile.status == 0)
            {
                var allText = rawFile.responseText;
                document.getElementById("code").value = allText;
            }
        }
    }
    rawFile.send();
}
function frame() {

    if(!paused){
        ctx.clearRect(0, 0, 800, 800);
        // Draw the floor
        ctx.drawImage(floor, 0, 0);
        
        // Update sensor readings
        var readings = [];
        for (var i = 0; i < sensors.length; i++) {
            var x = ~~(px + Math.cos(rot) * sensors[i][0] - Math.sin(rot) * sensors[i][1]);
            var y = ~~(py + Math.sin(rot) * sensors[i][0] + Math.cos(rot) * sensors[i][1]);
            if (x >= 0 && y >= 0 && x < 800 && y < 800) {
                var color = ctx.getImageData(x, y, 1, 1).data;
                ctx.fillStyle = "rgb(" + color[0] + "," + color[1] + "," + color[2] + ")";
                ctx.fillRect(20, 20 + 60 * i, 40, 40);
                ctx.strokeStyle = "black";
                ctx.strokeRect(20, 20 + 60 * i, 40, 40);
                readings.push((color[0] + color[1] + color[2]) / 3);
            }
            ctx.fillStyle = "teal"; 
            ctx.fillText("Sensor " + i, 20, 15 + 60 * i);
        }
        
        // Draw the bot
        ctx.save();
            // Transform
            ctx.translate(px, py);
            ctx.rotate(rot);
            // Draw the body
            ctx.lineWidth = 3;
            ctx.strokeStyle = "blue";
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, 2 * Math.PI);
            ctx.stroke();
            // Draw sensors
            ctx.strokeStyle = "red";
            for (var i = 0; i < sensors.length; i++) {
                ctx.beginPath();
                ctx.arc(sensors[i][0], sensors[i][1], radius / 5, 0, 2 * Math.PI);
                ctx.stroke();

                

            }
        ctx.restore();
        
        // Run the code
        var controls = code(state, readings);
        if (controls && controls.length == 2) {
            left_motor = controls[1];
            right_motor = controls[0];
        }
        
        // Update position and rotation
        var new_px = px;
        var new_py = py;
        var new_rot = rot;
        if (Math.abs(left_motor - right_motor) < 1.0e-6) { // basically going straight
            new_px = px + left_motor  * Math.cos(rot);
            new_py = py + right_motor * Math.sin(rot);
            new_rot = rot;
        }
        else {
            var r = (radius * 2) * (left_motor + right_motor)
                    / (2 * (right_motor - left_motor));
            var wd = (right_motor - left_motor) / (radius * 2);

            new_px = px + r * Math.sin(wd + rot) - r * Math.sin(rot);
            new_py = py - r * Math.cos(wd + rot) + r * Math.cos(rot);
            new_rot = (rot + wd) % (2 * Math.PI);
        }
        px = new_px;
        py = new_py;
        rot = new_rot;
    }

}

window.addEventListener("load", function() {
    canvas = document.getElementById("sc");
    ctx = canvas.getContext("2d");
    floor = document.getElementById("floor");


    readTextFile();

    document.getElementById("run").addEventListener("click", function() {
        px = 400;
        py = 400;
        rot = Math.PI;
        left_motor = 0;
        right_motor = 0;
        
        state = {};
        code = new Function('state', 'sensor', document.getElementById("code").value);
    });
    document.getElementById("pause").addEventListener("click", function() {
        if(paused){
            console.log("unpaused");
            document.getElementById("pause").innerHTML= "Unpaused";
            paused = false;
        }
        else{
            document.getElementById("pause").innerHTML= "Paused";
            paused = true;
        }
    })
    setInterval(frame, 20);
});
</script>
<style type="text/css">
.half {
    position: absolute;
    width: 49%;
    height: 90%;
    text-align: center;
}

.left {
    left: 0%;
}

.right {
    right: 0%;
}

.hidden {
    visibility: hidden;
}

#sc {
    width: 90%;
    border: 1px solid red;
}

#code {
    width: 90%;
    height: 90%;
    font-size: 1.2em;
}

</style>
</head>
<body>
    <div class="left half">
        <canvas id="sc" width="800" height="800"></canvas>
    </div>
    <div class="right half">
        <textarea id="code"></textarea>
        <br>
        <button id="run">Start</button>
        <button id="pause">Pause</button>
    </div>
    <div class="hidden">
        <img src="./Line Follower Sim_files/line.png" id="floor">
    </div>


</body></html>